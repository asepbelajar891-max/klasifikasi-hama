{% extends "layout.html" %}

{% block head_extra %}
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1/dist/cropper.min.css" type="text/css" />
{% endblock %}

{% block content %}
<h2 class="mb-4">Klasifikasi Penyakit Daun Tomat</h2>
<p>Seret dan lepas gambar daun tomat ke dalam kotak di bawah, atau klik untuk memilih file dari komputer Anda.</p>

<div id="upload-and-tips-section">
    <div class="row mb-3">
        <div class="col-12">
            <form action="{{ url_for('main.predict') }}" class="dropzone" id="upload-form">
                <div class="dz-message" data-dz-message>
                    <span><i class="bi bi-cloud-arrow-up-fill fs-1"></i><br>Seret & Lepas file di sini atau klik untuk memilih</span>
                    <hr class="w-50 mx-auto">
                    <div id="start-camera-wrapper">
                        <button id="start-camera-btn" type="button" class="btn btn-secondary" aria-label="Buka Kamera"><i class="bi bi-camera-fill"></i> Buka Kamera</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark-subtle border-secondary">
                    <div class="card-body py-3">
                        <h6 class="card-title mb-2"><i class="bi bi-lightbulb-fill"></i> Tips Pengambilan Gambar</h6>
                        <hr class="mt-2 mb-3">
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Gunakan pencahayaan yang cukup dan merata.</li>
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Pastikan fokus tajam pada gejala di daun.</li>
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Hindari bayangan yang menutupi area penting.</li>
                            <li class="mb-0"><i class="bi bi-x-circle-fill text-danger me-2"></i>Jangan mengambil gambar dari jarak terlalu jauh.</li>
                        </ul>
                    </div>
                </div>
        </div>
    </div>
</div>


<div id="camera-container" class="mt-4 text-center" style="display: none;">
    <h4>Tampilan Kamera</h4>
    <video id="video-feed" playsinline autoplay class="img-fluid rounded shadow-sm" style="max-height: 400px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="mt-3">
        <button id="capture-btn" class="btn btn-primary" aria-label="Ambil Gambar"><i class="bi bi-camera-reels-fill"></i> Ambil Gambar</button>
        <button id="toggle-flash-btn" class="btn btn-warning" style="display: none;"><i class="bi bi-lightning-fill"></i> Flash</button>
        <button id="stop-camera-btn" class="btn btn-danger"><i class="bi bi-x-circle-fill"></i> Tutup Kamera</button>
    </div>
</div>

<div id="image-preview-area" class="mt-4 text-center" style="display: none;">
    <h4>Pratinjau Gambar:</h4>
    <img id="selected-image-preview" src="#" alt="Pratinjau Gambar yang Dipilih" class="img-fluid rounded shadow-sm" style="max-height: 300px;">
</div>

<div id="result-area" class="mt-5" style="display: none;">
    <h3 class="mb-4 text-center">Hasil Analisis</h3>
    <div class="row d-flex justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-dark-subtle border-secondary">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <img id="image-preview" src="#" alt="Pratinjau Gambar" class="img-fluid rounded shadow-sm mb-3">
                            <p class="fst-italic" id="filename-display"></p>
                            
                        </div>
                        <div class="col-md-9">
                            <div id="main-prediction-display" class="mb-3">
                                <!-- Konten dinamis akan dimasukkan di sini oleh JS -->
                            </div>

                            <div id="feedback-alert" class="alert" role="alert"></div>
                            
                            <ul class="list-group">
                                <li id="prediction-1" class="list-group-item d-flex justify-content-between align-items-center list-group-item-primary"></li>
                                <li id="prediction-2" class="list-group-item d-flex justify-content-between align-items-center"></li>
                                <li id="prediction-3" class="list-group-item d-flex justify-content-between align-items-center"></li>
                            </ul>
                            
                            <div class="mt-3">
                                <a id="detail-link" href="#" class="btn btn-info" target="_blank" style="display: none;"><i class="bi bi-box-arrow-up-right"></i> Lihat Detail Analisis</a>
                            </div>
                            
                            <div class="alert alert-warning mt-4" role="alert">
                                <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Perhatian!</h4>
                                <p>Aplikasi ini adalah alat bantu diagnosis awal dan <strong>TIDAK</strong> menggantikan saran dari ahli pertanian (PPL) atau pakar. Gunakan informasi ini dengan bijak.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="spinner-overlay"></div>
<div id="loading-spinner" class="text-center">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-white mt-2">Menganalisis gambar...</p>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">Crop Gambar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="cropper-image" src="#" class="img-fluid" alt="Gambar untuk crop">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="crop-btn">Crop &amp; Prediksi</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notifikasi</strong>
            <small>Baru saja</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            <!-- Pesan akan dimasukkan di sini -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script src="https://unpkg.com/cropperjs@1/dist/cropper.min.js"></script>
<script>
    // --- Helper Functions ---
    function showSpinner() {
        document.getElementById('spinner-overlay').style.display = 'block';
        document.getElementById('loading-spinner').style.display = 'block';
    }

    function hideSpinner() {
        document.getElementById('spinner-overlay').style.display = 'none';
        document.getElementById('loading-spinner').style.display = 'none';
    }

    function showToast(message, isError = false) {
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toast-body');
        
        toastEl.className = 'toast ' + (isError ? 'text-bg-danger' : 'text-bg-success');
        toastBody.innerHTML = message;
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    function sendToPredict(blob, filename) {
        showSpinner();
        const formData = new FormData();
        formData.append('file', blob, filename);

        return fetch("{{ url_for('main.predict') }}", { method: 'POST', body: formData })
            .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)))
            .finally(() => hideSpinner());
    }

    let cropper = null;
    function openCropper(imageSrc, onCrop) {
        const cropImage = document.getElementById('cropper-image');
        cropImage.src = imageSrc;
        const cropModalEl = document.getElementById('cropModal');
        const cropModal = new bootstrap.Modal(cropModalEl);
        cropModal.show();

        cropModalEl.addEventListener('shown.bs.modal', () => {
            cropper = new Cropper(cropImage, { viewMode: 1 });
        }, { once: true });

        document.getElementById('crop-btn').onclick = () => {
            const canvas = cropper.getCroppedCanvas();
            cropModal.hide();
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            onCrop(canvas);
        };

        cropModalEl.addEventListener('hidden.bs.modal', () => {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }, { once: true });
    }

    function displayResults(response) {
        const resultArea = document.getElementById('result-area');
        resultArea.style.display = 'block';
        
        document.getElementById('image-preview').src = response.image_path;
        document.getElementById('filename-display').innerText = `File: ${response.original_filename || 'capture.jpg'}`;

        if (response.status === 'uncertain') {
            const feedbackAlert = document.getElementById('feedback-alert');
            feedbackAlert.className = 'alert alert-danger';
            feedbackAlert.innerHTML = `<strong>Tidak Dapat Diidentifikasi.</strong> ${response.message}`;
            document.querySelector('.list-group').style.display = 'none';
            document.getElementById('detail-link').style.display = 'none';
            document.getElementById('penanganan-link').style.display = 'none';
            return;
        }
        
        // Tampilkan kembali list jika sebelumnya disembunyikan
        document.querySelector('.list-group').style.display = 'block';

        // Main Prediction Display
        const { top_prediction, secondary_prediction, tertiary_prediction } = response.analysis;
        const mainPredictionDisplay = document.getElementById('main-prediction-display');
        mainPredictionDisplay.innerHTML = `<h4 class="mb-0">Prediksi Utama: <strong>${top_prediction.name} - <em>${response.indonesian_name}</em></strong></h4>`;

        // Feedback Alert
        const feedbackAlert = document.getElementById('feedback-alert');
        feedbackAlert.className = `alert ${response.feedback.alert_class}`;
        feedbackAlert.innerHTML = `<span class="fw-bold">SKOR: ${top_prediction.score}%</span> - ${response.feedback.message}`;


        // Predictions List
        const predictions = [top_prediction, secondary_prediction, tertiary_prediction];
        
        for (let i = 1; i <= 3; i++) {
            const pred = predictions[i-1];
            const li = document.getElementById(`prediction-${i}`);
            if (pred && pred.name !== "N/A") {
                const scoreText = i === 1 ? `${pred.score}%` : `${pred.score}%`;
                li.innerHTML = `<span>${pred.name}</span> <span class="badge bg-primary rounded-pill">${scoreText}</span>`;
                li.style.display = 'flex';
            } else {
                li.style.display = 'none';
            }
        }

        // Action Buttons
        const detailLink = document.getElementById('detail-link');

        if (response.riwayat_id) {
            detailLink.href = `/riwayat/${response.riwayat_id}`;
            detailLink.style.display = 'inline-block';
        } else {
            detailLink.style.display = 'none';
        }

        if (response.penanganan_slug) {
            // penangananLink is intentionally removed from this page, so no action is needed.
        }
    }

    // --- Dropzone Initialization ---
    Dropzone.options.uploadForm = {
        paramName: "file",
        maxFilesize: 10,
        maxFiles: 1,
        acceptedFiles: "image/*",
        autoProcessQueue: false,
        dictDefaultMessage: "Seret & Lepas file di sini atau klik untuk memilih",
        addRemoveLinks: true,
        dictRemoveFile: "Hapus file",

        init: function() {
            const myDropzone = this;
            myDropzone.on("addedfile", file => {
                document.getElementById('result-area').style.display = 'none';
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('selected-image-preview').src = e.target.result;
                    document.getElementById('image-preview-area').style.display = 'block';

                    openCropper(e.target.result, canvas => {
                        selectedImagePreview.src = canvas.toDataURL('image/jpeg');
                        canvas.toBlob(blob => {
                            sendToPredict(blob, file.name)
                                .then(data => {
                                    if (data.status === 'not_a_leaf') {
                                        showToast(data.message, true);
                                    } else {
                                        displayResults(data);
                                        showToast('Klasifikasi berhasil!');
                                    }
                                })
                                .catch(err => {
                                    showToast(err.error || 'Gagal melakukan klasifikasi.', true);
                                })
                                .finally(() => {
                                    myDropzone.removeFile(file);
                                });
                        }, 'image/jpeg');
                    });
                };
                reader.readAsDataURL(file);
            });
            myDropzone.on("removedfile", () => {
                if (myDropzone.files.length === 0) {
                    document.getElementById('image-preview-area').style.display = 'none';
                }
            });
        }
    };

    // --- Camera Logic ---
    const startCameraBtn = document.getElementById('start-camera-btn');
    const stopCameraBtn = document.getElementById('stop-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const toggleFlashBtn = document.getElementById('toggle-flash-btn');
    const cameraContainer = document.getElementById('camera-container');
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('canvas');
    const uploadAndTipsSection = document.getElementById('upload-and-tips-section');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const selectedImagePreview = document.getElementById('selected-image-preview');

    let stream = null;
    let flashOn = false;

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            cameraContainer.style.display = 'block';
            uploadAndTipsSection.style.display = 'none';
            document.getElementById('result-area').style.display = 'none';
            imagePreviewArea.style.display = 'none';
            checkFlashSupport();
        } catch (err) {
            showToast('Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.', true);
        }
    }

    function checkFlashSupport() {
        if (!stream) return;
        const videoTrack = stream.getVideoTracks()[0];
        if (videoTrack && videoTrack.getCapabilities().torch) {
            toggleFlashBtn.style.display = 'inline-block';
        }
    }

    function toggleFlashlight() {
        if (!stream) return;
        const videoTrack = stream.getVideoTracks()[0];
        if (!videoTrack.getCapabilities().torch) {
            showToast('Flash tidak didukung pada perangkat ini.', true);
            return;
        }
        flashOn = !flashOn;
        videoTrack.applyConstraints({ advanced: [{ torch: flashOn }] })
            .then(() => {
                toggleFlashBtn.classList.toggle('btn-warning', !flashOn);
                toggleFlashBtn.classList.toggle('btn-info', flashOn);
            })
            .catch(() => showToast('Gagal mengubah status flash.', true));
    }

    async function stopCamera() {
        if (stream) {
            const videoTrack = stream.getVideoTracks()[0];
            if (flashOn && videoTrack && videoTrack.getCapabilities().torch) {
                try {
                    await videoTrack.applyConstraints({ advanced: [{ torch: false }] });
                    flashOn = false;
                    toggleFlashBtn.classList.remove('btn-info');
                    toggleFlashBtn.classList.add('btn-warning');
                } catch (e) {
                    console.error("Gagal mematikan flash:", e);
                }
            }
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        cameraContainer.style.display = 'none';
        uploadAndTipsSection.style.display = 'block';
        toggleFlashBtn.style.display = 'none';
    }

    function captureImage() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL('image/jpeg');
        selectedImagePreview.src = dataUrl;
        imagePreviewArea.style.display = 'block';

        openCropper(dataUrl, croppedCanvas => {
            selectedImagePreview.src = croppedCanvas.toDataURL('image/jpeg');
            croppedCanvas.toBlob(blob => {
                sendToPredict(blob, 'capture.jpg')
                    .then(data => {
                        if (data.status === 'not_a_leaf') {
                            showToast(data.message, true);
                        } else {
                            displayResults(data);
                            showToast('Klasifikasi dari kamera berhasil!');
                        }
                    })
                    .catch(error => {
                        showToast(error.error || 'Gagal melakukan klasifikasi.', true);
                    })
                    .finally(() => {
                        stopCamera();
                    });
            }, 'image/jpeg');
        });
    }

    startCameraBtn.addEventListener('click', function(event) {
        event.stopPropagation(); // Mencegah Dropzone membuka file explorer
        startCamera();
    });
    stopCameraBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', captureImage);
    toggleFlashBtn.addEventListener('click', toggleFlashlight);
</script>
{% endblock %}